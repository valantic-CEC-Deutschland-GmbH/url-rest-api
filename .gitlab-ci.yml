image: registry.gitlab.nxs360.com/docker/php:8.1-cli

stages:
  - validation
  - deploy
  - post-test
  - release

#tests:coverage:
#  stage: validation
#  script:
#    - apt-get update && apt-get install -y nodejs && apt-get clean
#    - node -v
#    - npm -v
#    - composer validate
#    - composer install
#    - composer cs-check
#    - composer md-check
#    - composer test
#    - composer stan
#  coverage: '/^\s*Lines:\s*\d+.\d+\%/'
#  artifacts:
#    expire_in: 30 days
#    paths:
#      - tests/_output/

release:
  image: node:12-buster-slim
  stage: release
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends git-core ca-certificates
    - npm install -g semantic-release @semantic-release/gitlab
  script:
    - semantic-release
#  rules:
#    - if: $CI_COMMIT_BRANCH == "master"

pages:
  image: ruby:2.7
  stage: deploy
  script:
    - "mv tests/_output/coverage/ public/"
  artifacts:
    expire_in: 30 days
    paths:
      - public
  only:
    - master

#tagging:
##  only:
##    - master
#  stage: deploy
#  script:
#    - git config --global user.name "${GITLAB_USER_NAME}"
#    - git config --global user.email "${GITLAB_USER_EMAIL}"
#    - tag=$(cat composer.json | grep version | grep -Eo "[[:digit:]]+\.[[:digit:]]+\.[[:digit:]]+")
#    - git tag "$tag"
#    - git push --tags http://root:$ACCESS_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git HEAD:master

deploy:composer:
  stage: deploy
  script:
    - version=$([[ -z "$CI_COMMIT_TAG" ]] && echo "branch=$CI_COMMIT_REF_NAME" || echo "tag=$CI_COMMIT_TAG")
    - response=$(curl -s -w "\n%{http_code}" $insecure --data $version $URL)
    - code=$(echo "$response" | tail -n 1)
    - body=$(echo "$response" | head -n 1)
    # Output state information
    - |
      if [ $code -eq 201 ]; then
        echo "Package created - Code $code - $body";
      else
        echo "Could not create package - Code $code - $body";
        exit 1
      fi
  variables:
    URL: "${CI_API_V4_URL}/projects/$CI_PROJECT_ID/packages/composer?job_token=$CI_JOB_TOKEN"
  rules:
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - if: $CI_COMMIT_TAG =~ /^?[0-9]+[.][0-9]+([.][0-9]+)?$/

